name: GitHub Actions Demo
#on: [push]
on:
  repository_dispatch:
    types: [hogehoge]
  workflow_dispatch:

env: 
  NODE_SERVER_IP: 121
  NODE_PORT: 8080
  
jobs:

  deploy-for-test:
    runs-on: ubuntu-latest
    steps: 
      - run: echo "hoge"
    
  api-test:
    name: api-test
    runs-on: ubuntu-latest
    needs: deploy-for-test
    container: alpine:3.14.2
    steps:
      - run: curl http://${env.NODE_SERVER_IP}/greeting
      
      
  image-build-release:
    name: image-build-release
    runs-on: ubuntu-latest
    needs: api-test
    container: alpine:3.14.2
    if: ${{ github.ref }} == ^refs/heads/release-.*$ || ${{ github.ref }} == ^refs/heads/hotfix-.*$
    steps: 
      - name: push-image-for-release
        run: |
          echo "hogehoge"
          #TODO: install docker
          #TODO: login to registory
          #TODO: docker tag hogehoge
          #TODO: docker push hogehoge


  push-helm:
    name: push-helm
    runs-on: ubuntu-latest
    needs: image-build-release
    container: alpine:3.14.2
    if: ${{ github.ref }} == ^refs/heads/release-.*$ || ${{ github.ref }} == ^refs/heads/hotfix-.*$
    steps: 
      - name: checkout-repository
        uses: actions/checkout@v2
      - name: install-helm
        uses: ./github/actions/install-helm
      - name: set-variable
        run:  echo "CHART_NAME=$(echo "GITHUB_REPOSITORY" | awk -F '{print $2}')" >> ${GITHUB_ENV}
      - name: push-chart
        run: | 
          helm plugin insntall
          #TODO: set URL of repository with "helm repo"
          #TODO: 書き換え
          #TODO: helm push registory
          
